Общее описание:

При визите пациента ко врачу, надо начислять премиальное вознаграждение в размере 5% от стоимости визита тому врачу, который рекомендовал пациенту пройти процедуры.
Тестовое задание - сделать хранимку, которая будет возвращать табличку с данными для отчета. Формирование итоговых сумм производится средствами sql.
 
Пояснения:
 
1. Визиты хранятся в dbo.visits.
2. Услуги визита хранятся в dbo.visits_services (join dbo.visits on visit_id)
3. Услуга считается оказанной, если dbo.status.service_done=1 (join dbo.visits on status_id). При выборе визитов, и при поиске предыдущего посещения, нас интересуют только оказанные услуги.
4. Информация о враче-рекомендателе хранится в dbo.visits.doctor_id2. То есть если в визите заполнены поля doctor_id и doctor_id2, это значит что пациента принимает врач doctor_id по рекомендации врача doctor_id2. Поле doctor_id заполнено всегда, doctor_id2 - может быть Null. Нас интересуют только записи с doctor_id2 Not Null
5. Специальность врача хранится в таблице doctors_professions:
  visits inner join doctors on doctor_id inner join doctors_professions
  Мастерами маникюра-педикюра считаем врачей, у которых в названии профессии есть слово "маникюр".
6. Если услуги оказывал специалист по маникюру-педикюру, то из визита берем только самую дорогую услугу, остальные услуги не учитываем.
7. Для всех остальных (не мастеров маникюра) берем полную стоимость оказанных по визиту услуг.
8. Финальная стомость услуг, с учетом округлений и скидок, хранится в visits.cost_with_discount и в visits_services.cost_with_discount. Сумма visits_services.cost_with_discount по услугам визита совпадает с visits.cost_with_discount визита. Заполнение полей cost_with_discount производится триггерами, в тестовой базе триггера удалены.
9. Дата визита хранится в поле dbo.visits.dd. Время визита хранится отдельно от даты, в полях h, mins, h_mins.
10. По тестовому заданию нужен только SQL, в виде хранимки или в виде скрипта.
11.1. Для всех визитов, попавших в отчет, проверяем наличие предшествующих визитов этого пациента к тому же лечащему врачу. Если пациент уже приходил к этому врачу, то визит отображается в отчете, но премиальные по нему не начисляются, и ставится отметка что визит повторный.
11.2. Например, если пациента Иванова к врачу Маникюрову направили врач Хирургов в апреле и врач Терапевтов в мае, учитываем только направление Хирургова. Направление Терапевтова - повторное/ошибочное, желательно чтобы оно попадало в итоговый отчет, но с припиской "Ошибка/повторно" и с нулевой суммой премиальных %.
11.3. Если пациент впервые посетил врача Маникюрова 14 апреля (doctor_id=ссылка на Маникюрова, doctor_id2=Null), а посещение по рекомендации (doctor_id=ссылка на Маникюрова, doctor_id2=ссылка на Пилюлькина) произошло 16 мая, рекомендацию Пилюлькина считаем ошибочной. На премирование влияют только случаи, когда рекомендация привела к первичному посещению пациентом другого врача.
 
Тестовая задача - написать sql для получения описанного отчета.
Входные параметры: @d1 not null (обязательная дата начала отчетного периода), @d2 not null (обязательная дата окончания отчетного периода), @doctor_id (исполнитель - фильтрация возможна, но не обязательна), @doctor_id2 (рекомендатель - фильтрация возможна, но не обязательна), @group_by (выбор варианта группировки).
Варианты группировки результата: по пациенту, по исполнителю, по рекомендателю, по дате (в виде yyyy-mm-dd), по месяцу (в виде yyyy-mm), по специальности врача.
В секции детализации одна строка = один визит
Группровка и вывод итоговых сумм обеспечивается средствами sql. Результат должен быть представлен в виде одной таблички.
 
db_for_test_task.rar = бак MS SQL 2005 express edition
 
Референсное решение (57 строк кода без учета комментариев) предоставляется после выполнения тестового задания. Моя оценка требуемого на задачу времени - около 4 часов.

Образец результата: Группировка Рекомендовавший врач.
 
 	Примечание	Оказано услуг	Премиальные
пациент Ивашкин И.И. к врачу Касторкина К.К. по рекомендации Лекарева Л.Л. 10.11.2013 11:00	посещение Касторкина К.К.  повторное, пред. визит 25.10.2013, ошибка	400	0
пациент Иванов И.И. к врачу Пилюлькин П.П. по рекомендации Лекарева Л.Л. 15.11.2013 10:00	 	100	5
ИТОГО Лекарева Л.Л.	 	500	5
пациент Петров П.П. к врачу Пилюлькин П.П. по рекомендации Бинтомотова Б.Б. 12.11.2013 10:00	 	1000	50
ИТОГО Бинтомотова Б.Б.	 	1000	50
пациент Сидоров С.С. к врачу Касторкина К.К. по рекомендации Ноголомов Н.Н. 12.11.2013 10:00	 	200	10
ИТОГО Ноголомов Н.Н.	 	200	10
ИТОГО ПО ОТЧЕТУ	 	1700	65
 
Образец результата: Группировка Лечащий врач
 	Примечание	Оказано услуг	Премиальные
пациент Иванов И.И. к врачу Пилюлькин П.П. по рекомендации Лекарев Л.Л. 15.11.2013 10:00	 	100	5
пациент Петров П.П. к врачу Пилюлькин П.П. по рекомендации Бинтомотова Б.Б. 12.11.2013 10:00	 	1000	50
ИТОГО Пилюлькин П.П.	 	1100	55
пациент Сидоров С.С. к врачу Касторкина К.К. по рекомендации Ноголомов Н.Н. 12.11.2013 10:00	 	200	10
пациент Ивашкин И.И. к врачу Касторкина К.К. по рекомендации Лекарева Л.Л. 10.11.2013 11:00	посещение Касторкина К.К.  повторное, пред. визит 25.10.2013, ошибка	400	0
ИТОГО Касторкина К.К.	 	600	10
ИТОГО ПО ОТЧЕТУ	 	1700	65
 
 